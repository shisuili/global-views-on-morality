<!DOCTYPE html>
<html>
<head>
<script src="http://d3js.org/d3.v3.min.js"></script>
<script src="http://d3js.org/queue.v1.min.js"></script>
<script src="http://d3js.org/d3.geo.projection.v0.min.js"></script>
<script src="http://labratrevenge.com/d3-tip/javascripts/d3.tip.v0.6.3.js"></script>
<link rel="stylesheet" type="text/css" href="main.css">
  <meta charset="utf-8">
  <title>Global Views on Morality</title>
</head>

<body>
	<div id = "nav">
		<div>
			<p id = "header">Global Views on Morality</p>
		</div>		
	</div>
	<script>
	var width = 1200,
	    height = 500;



	var svg = d3.select("body").append("svg")
	    .attr("width", width)
	    .attr("height", height);



	var projection = d3.geo.naturalEarth()
    .scale(167)
    .translate([width / 2.5, height / 2])
    .precision(.1);

	var color = d3.scale.linear()
	    .domain([0,100])
	    .range(["white", "red"]);

	var path = d3.geo.path().projection(projection);

	queue()
	.defer(d3.json, "world_countries.json")
	.defer(d3.csv, "data/3.csv")
	.await(ready);

	function ready(error, world, questionaire) {
		if (error) throw error;

		var CountryByName = d3.nest()
		    .key(function(d) {return d["Country"]})
		    .map(questionaire, d3.map);

		var CountrySorted = d3.nest()
		    .key(function(d) {return d["Country"]})
		    .entries(questionaire);

		    CountrySorted.sort(function(a,b) {return parseFloat(b.values[0]["Morally unacceptable"]) - parseFloat(a.values[0]["Morally unacceptable"]);});


		var country = svg.append("g").selectAll("g")
		.data(world.features)
		.enter()
		.append("g")
		.append("path")
		.attr("d", path)
		.attr("class", "country")
		.attr("transform", "translate(25, 50)")
		.style('stroke', 'white')
        .style('stroke-width', 0.5)
        .style('fill', function(d) { 
			if (CountryByName.has(d.properties.name)) {
				return color(parseFloat(CountryByName.get(d.properties.name)[0]["Morally unacceptable"]));}
else {
			return 'lightgrey';
		}
			})
        .on("mouseover", function(d) {
        	d3.select(this)
        	.style('fill', 'orange');

        	if (CountryByName.has(d.properties.name)) {
				bar.select("#bar" + d.properties.name)
				.style("fill", "orange");
			}
        })
        .on("mouseout", function(d) {
        	d3.select(this)
        	.style('fill', function(d) { 
			if (CountryByName.has(d.properties.name)) {
				return color(parseFloat(CountryByName.get(d.properties.name)[0]["Morally unacceptable"]));}
else {
			return 'lightgrey';
		}
			});

			if (CountryByName.has(d.properties.name)) {
				bar.select("#bar" + d.properties.name)
				.style("fill", "red");
			}
        });


		//bar chart
		var chart = svg.append("g")
		    .attr("width", 300)
		    .attr("height", 500)
		    .attr("transform", "translate(1000, 50)");

		    var countries = d3.keys(CountrySorted);


		    var barwidth = 11;



		    var bar = chart.selectAll("g")
		    .data(CountrySorted)
		    .enter()
		    .append("g")
		    .attr("transform", function(d, i) { return "translate(0, " + i * barwidth + ")"});

		    	var tip = d3.tip()
  .attr('class', 'd3-tip')
  .offset([-10, 0])
  .html(function(d) {
    return "<strong>Percentage:</strong> <span style='color:red'>" + parseFloat(CountryByName.get(d.key)[0]["Morally unacceptable"]) + "</span>";
  })

	svg.call(tip);



		    bar.append("rect")
		    .attr("class", "bar")
		    .attr("id", function (d) {return "bar" + d.key;})
		    .attr("width", function (d) {return parseFloat(CountryByName.get(d.key)[0]["Morally unacceptable"]);})
		    .attr("height", 9)
		    .attr("fill", "red")
		    .on('mouseover', function (d) {

		    	d3.select(this)
        	    .style('fill', 'orange');

		    	country.filter(function (dd) {
		    		return dd.properties.name === d.key;
		    	})
		    	.style("fill", "orange");

		    	/*tip.show;*/})

            .on('mouseout', function (d) {

d3.select(this)
        	.style('fill', 'red');

		    	country.filter(function (dd) {
		    		return dd.properties.name === d.key;
		    	})
		    	.style('fill', function(d) { 
		    		debugger;
				return color(parseFloat(CountryByName.get(d.properties.name)[0]["Morally unacceptable"]));
			});

		    	/*tip.hide;*/});



		    bar.append("text")
		    .attr("class", "text")
		    .attr("x", function(d) {return  - 10;})
		    .attr("y", 0)
		    .attr("dy", "0.8em")
		    .text(function(d) { return d.key});



	
};
	





	</script>

</body>
</html>